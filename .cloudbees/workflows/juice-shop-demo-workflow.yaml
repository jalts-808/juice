apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: juice-shop-build-and-scan

on:
  push:
    branches:
      - '**'

jobs:
  build-and-scan:
    steps:
      # 1) Clone code from public repo using alpine/git pinned
      - name: Clone code
        uses: docker://alpine/git:2.36.3
        shell: sh
        run: |
          git config --global --add safe.directory /cloudbees/workspace
          git clone https://github.com/juice-shop/juice-shop.git .

      # 2) Install Node modules pinned to node
      - name: Install Node modules
        uses: docker://node:16.19.1
        shell: sh
        run: |
          npm install

      # 3) Build Juice Shop (npm run build:frontend)
      - name: Build the app
        uses: docker://node:16.19.1
        shell: sh
        run: |
          npm run build:frontend

      # 4) Gitleaks secret scan pinned
      - name: Gitleaks
        uses: docker://zricethezav/gitleaks:v8.17.0
        shell: sh
        run: |
          gitleaks detect --exit-code 0 --redact

      # 5) Njsscan (Node.js SAST) with a valid tag
      #    'opensecurity/njsscan:0.9.3' is known to exist
      - name: Njsscan SAST
        uses: docker://opensecurity/njsscan:0.9.3
        shell: sh
        run: |
          njsscan . --exit-code 0

      # 6) TruffleHog secret scan pinned
      - name: TruffleHog
        uses: docker://trufflesecurity/trufflehog:3.12.0
        shell: sh
        run: |
          trufflehog filesystem --no-update . || true

      # 7) Retire.js pinned
      - name: Retire.js
        uses: docker://retirejs/retire.js:2.2.6
        shell: sh
        run: |
          retire --path . --exitwith 0
